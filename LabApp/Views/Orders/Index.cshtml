@model IEnumerable<LabApp.Models.Order>
@{
    ViewData["Title"] = "Moje zamowienia";
}

<h1>@ViewData["Title"]</h1>

@if (!Model.Any())
{
    <div class="alert alert-info">Nie masz jeszcze zamowien.</div>
}
else
{
    <div class="accordion" id="ordersAccordion">
    @{
        var index = 0;
    }
@foreach (var order in Model)
{
    var collapseId = $"orderCollapse{index}";
    var headingId = $"orderHeading{index}";
    var publicId = string.IsNullOrWhiteSpace(order.PublicId) ? $"ORD-{order.Id}" : order.PublicId;
    <div class="accordion-item">
        <h2 class="accordion-header" id="@headingId">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                Zamowienie @publicId - @order.CreatedAt.ToLocalTime().ToString("g") - @($"{order.Total:C}")
            </button>
        </h2>
        <div id="@collapseId" class="accordion-collapse collapse" aria-labelledby="@headingId" data-bs-parent="#ordersAccordion">
            <div class="accordion-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <strong>Numer zamowienia:</strong>
                    <button type="button" class="btn btn-sm btn-outline-secondary copy-order-id" data-order-id="@publicId">@publicId</button>
                </div>
                <p><strong>Adres:</strong> @order.FullName, @order.Street, @order.PostalCode @order.City</p>
                <p><strong>Email:</strong> @order.Email</p>
                <p><strong>Telefon:</strong> @order.Phone</p>
                <p class="text-muted small mb-3">Data utworzenia: @order.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</p>
                <table class="table table-sm">
                    <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Cena</th>
                                <th>Ilosc</th>
                                <th>Suma</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var item in order.Items)
                        {
                            <tr>
                                <td>@item.ProductName</td>
                                <td>@($"{(item.PromoPrice ?? item.UnitPrice):C}")</td>
                                <td>@item.Quantity</td>
                                <td>@($"{item.LineTotal:C}")</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        index++;
    }
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('click', e => {
            const btn = e.target.closest('.copy-order-id');
            if (!btn) return;
            const text = btn.getAttribute('data-order-id');
            if (!text) return;
            navigator.clipboard?.writeText(text).then(() => {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                btn.textContent = text + ' (skopiowano)';
                setTimeout(() => {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                    btn.textContent = text;
                }, 1200);
            });
        });
    </script>
}
